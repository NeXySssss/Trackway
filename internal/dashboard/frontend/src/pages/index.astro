---
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Trackway Observability</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #090d14;
        --bg-b: #0f1623;
        --panel: #111a2b;
        --panel-soft: #1a253a;
        --line: #25344f;
        --line-strong: #35507a;
        --ink: #eaf2ff;
        --muted: #a6b8d7;
        --accent: #65b8ff;
        --good: #5cd89a;
        --bad: #ff6f8f;
        --warn: #ffc36d;
      }

      :root[data-theme="light"] {
        --bg: #eff3fb;
        --bg-b: #dfe8fa;
        --panel: #ffffff;
        --panel-soft: #f8faff;
        --line: #d2dcef;
        --line-strong: #b8c7e5;
        --ink: #13233e;
        --muted: #5e7396;
        --accent: #2d78ea;
        --good: #198f5e;
        --bad: #c1304e;
        --warn: #a77417;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--ink);
        font-family: "IBM Plex Sans", sans-serif;
        background:
          radial-gradient(1200px 500px at 100% -10%, #1d2840, transparent),
          radial-gradient(900px 420px at 0% 0%, #1a2741, transparent),
          linear-gradient(165deg, var(--bg), var(--bg-b));
        min-height: 100vh;
      }

      main {
        width: min(1440px, calc(100% - 1.4rem));
        margin: 0.8rem auto 1.4rem;
        display: grid;
        gap: 0.85rem;
      }

      .panel {
        background: linear-gradient(160deg, color-mix(in srgb, var(--panel) 90%, #000 10%), var(--panel));
        border: 1px solid var(--line);
        border-radius: 14px;
        box-shadow: 0 16px 36px rgba(0, 0, 0, 0.2);
      }

      .header {
        padding: 0.8rem 0.9rem;
        display: grid;
        gap: 0.65rem;
      }

      .header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.55rem;
      }

      h1 {
        margin: 0;
        font-size: clamp(1.08rem, 2.6vw, 1.5rem);
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .subtitle {
        margin: 0.16rem 0 0;
        color: var(--muted);
        font-size: 0.86rem;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
      }

      button,
      select,
      input {
        font: inherit;
      }

      button,
      select,
      input {
        border: 1px solid var(--line-strong);
        border-radius: 9px;
        background: color-mix(in srgb, var(--panel-soft) 92%, var(--accent) 8%);
        color: var(--ink);
        padding: 0.43rem 0.65rem;
      }

      button {
        cursor: pointer;
      }

      .btn-primary {
        border-color: color-mix(in srgb, var(--accent) 60%, var(--line) 40%);
        background: linear-gradient(145deg, color-mix(in srgb, var(--accent) 35%, var(--panel) 65%), var(--panel-soft));
      }

      .btn-danger {
        border-color: color-mix(in srgb, var(--bad) 50%, var(--line) 50%);
        background: color-mix(in srgb, var(--bad) 17%, var(--panel) 83%);
        color: color-mix(in srgb, var(--bad) 72%, var(--ink) 28%);
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.45rem;
      }

      .chip {
        border: 1px solid var(--line-strong);
        border-radius: 999px;
        padding: 0.26rem 0.56rem;
        font-size: 0.78rem;
        color: var(--muted);
        background: color-mix(in srgb, var(--panel-soft) 85%, var(--accent) 15%);
      }

      .chip strong {
        margin-left: 0.2rem;
        color: var(--ink);
      }

      .content-grid {
        display: grid;
        gap: 0.85rem;
        grid-template-columns: 1.25fr 1fr;
      }

      .chart-panel {
        padding: 0.72rem 0.8rem 0.68rem;
      }

      .panel-title {
        margin: 0 0 0.5rem;
        font-size: 0.9rem;
        color: var(--muted);
      }

      .chart {
        width: 100%;
        height: 300px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: color-mix(in srgb, var(--panel-soft) 90%, black 10%);
      }

      .short-chart {
        height: 280px;
      }

      .table-panel,
      .logs-panel {
        padding: 0.72rem 0.8rem;
      }

      .targets-controls {
        display: grid;
        grid-template-columns: 1fr 1fr 130px auto auto;
        gap: 0.42rem;
        margin-bottom: 0.56rem;
      }

      .targets-controls input {
        min-width: 0;
      }

      .table-wrap {
        width: 100%;
        overflow: auto;
        border: 1px solid var(--line);
        border-radius: 10px;
      }

      table {
        width: 100%;
        min-width: 760px;
        border-collapse: collapse;
      }

      th,
      td {
        text-align: left;
        padding: 0.5rem 0.54rem;
        border-bottom: 1px solid color-mix(in srgb, var(--line) 78%, transparent 22%);
        font-size: 0.84rem;
      }

      th {
        color: var(--muted);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        background: color-mix(in srgb, var(--panel-soft) 95%, var(--accent) 5%);
      }

      tbody tr {
        cursor: pointer;
      }

      tbody tr:hover {
        background: color-mix(in srgb, var(--panel-soft) 88%, var(--accent) 12%);
      }

      tbody tr.active {
        background: color-mix(in srgb, var(--accent) 23%, var(--panel-soft) 77%);
      }

      .status-pill {
        border-radius: 999px;
        padding: 0.14rem 0.5rem;
        font-size: 0.74rem;
        font-weight: 600;
      }

      .status-up {
        background: color-mix(in srgb, var(--good) 20%, var(--panel) 80%);
        color: var(--good);
      }

      .status-down {
        background: color-mix(in srgb, var(--bad) 20%, var(--panel) 80%);
        color: var(--bad);
      }

      .status-unknown {
        background: color-mix(in srgb, var(--warn) 18%, var(--panel) 82%);
        color: var(--warn);
      }

      .logs-top {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.52rem;
        margin-bottom: 0.56rem;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.42rem;
      }

      pre {
        margin: 0;
        padding: 0.72rem;
        border-radius: 10px;
        border: 1px solid var(--line);
        background: color-mix(in srgb, var(--panel-soft) 92%, #000 8%);
        font: 0.76rem/1.42 "IBM Plex Mono", monospace;
        min-height: 260px;
        max-height: 520px;
        overflow: auto;
      }

      .status-line {
        margin: 0;
        color: var(--muted);
        font-size: 0.78rem;
      }

      .auth-gate {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(6, 10, 16, 0.78);
        padding: 0.8rem;
      }

      .auth-card {
        width: min(560px, 100%);
        border: 1px solid var(--line-strong);
        border-radius: 14px;
        background: var(--panel);
        padding: 1rem;
      }

      .auth-card h3 {
        margin: 0 0 0.45rem;
      }

      .auth-card p {
        margin: 0.26rem 0;
        color: var(--muted);
        font-size: 0.86rem;
      }

      .hidden {
        display: none;
      }

      @media (max-width: 1060px) {
        .content-grid {
          grid-template-columns: 1fr;
        }

        .chart {
          height: 260px;
        }
      }

      @media (max-width: 720px) {
        main {
          width: calc(100% - 0.74rem);
          gap: 0.64rem;
        }

        .header,
        .chart-panel,
        .table-panel,
        .logs-panel {
          padding: 0.64rem;
        }

        .header-row {
          align-items: flex-start;
        }

        .actions {
          width: 100%;
        }

        .actions button,
        .actions select {
          flex: 1 1 auto;
        }

        .chart {
          height: 230px;
        }

        .targets-controls {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <section class="panel header">
        <div class="header-row">
          <div>
            <h1>Trackway Observability Dashboard</h1>
            <p class="subtitle">Time-series availability, failure trend, and full transport logs.</p>
          </div>
          <div class="actions">
            <select id="range-select">
              <option value="1">1h</option>
              <option value="3">3h</option>
              <option value="6">6h</option>
              <option value="12">12h</option>
              <option value="24" selected>24h</option>
              <option value="48">48h</option>
            </select>
            <button id="theme-btn" type="button">Theme</button>
            <button id="refresh-btn" class="btn-primary" type="button">Refresh</button>
            <button id="logout-btn" class="btn-danger" type="button">Logout</button>
          </div>
        </div>
        <div class="chips">
          <span class="chip">Total <strong id="summary-total">0</strong></span>
          <span class="chip">UP <strong id="summary-up">0</strong></span>
          <span class="chip">DOWN <strong id="summary-down">0</strong></span>
          <span class="chip">UNKNOWN <strong id="summary-unknown">0</strong></span>
          <span class="chip">Session <strong id="session-expiry">-</strong></span>
          <span class="chip">Snapshot <strong id="snapshot-time">-</strong></span>
        </div>
      </section>

      <section class="content-grid">
        <article class="panel chart-panel">
          <p class="panel-title">Availability Timeline (hover for precise time)</p>
          <div id="timeline-chart" class="chart"></div>
        </article>
        <article class="panel chart-panel">
          <p class="panel-title">Current State Distribution</p>
          <div id="distribution-chart" class="chart short-chart"></div>
        </article>
      </section>

      <section class="panel table-panel">
        <p class="panel-title">Targets</p>
        <div class="targets-controls">
          <input id="target-name-input" type="text" placeholder="name (example: api-main)" />
          <input id="target-address-input" type="text" placeholder="address (example: 100.64.0.10)" />
          <input id="target-port-input" type="number" min="1" max="65535" value="443" />
          <button id="target-save-btn" type="button" class="btn-primary">Add / Update</button>
          <button id="target-delete-btn" type="button" class="btn-danger">Delete</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Endpoint</th>
                <th>Status</th>
                <th>Last Changed</th>
                <th>Last Checked</th>
              </tr>
            </thead>
            <tbody id="status-table-body"></tbody>
          </table>
        </div>
      </section>

      <section class="panel logs-panel">
        <div class="logs-top">
          <p class="panel-title" style="margin: 0;">Logs</p>
          <div class="controls">
            <select id="track-select"></select>
            <input id="limit-input" type="number" min="200" max="100000" step="100" value="10000" />
            <button id="logs-btn" type="button">Load Logs</button>
          </div>
        </div>
        <p id="logs-meta" class="status-line">No logs loaded.</p>
        <pre id="logs-output">(no data)</pre>
      </section>

      <p id="status-line" class="status-line"></p>
    </main>

    <div id="auth-gate" class="auth-gate hidden">
      <div class="auth-card">
        <h3>Authorization required</h3>
        <p>Send <code>/authme</code> to your Telegram bot and open the link.</p>
        <p>If opened inside Telegram Mini App, authorization is attempted automatically.</p>
        <p>Session remains valid until browser restart or 24 hours.</p>
      </div>
    </div>

    <script>
      import * as echarts from "echarts";

      const ui = {
        statusTableBody: document.getElementById("status-table-body"),
        rangeSelect: document.getElementById("range-select"),
        trackSelect: document.getElementById("track-select"),
        limitInput: document.getElementById("limit-input"),
        targetNameInput: document.getElementById("target-name-input"),
        targetAddressInput: document.getElementById("target-address-input"),
        targetPortInput: document.getElementById("target-port-input"),
        targetSaveBtn: document.getElementById("target-save-btn"),
        targetDeleteBtn: document.getElementById("target-delete-btn"),
        logsOutput: document.getElementById("logs-output"),
        logsMeta: document.getElementById("logs-meta"),
        statusLine: document.getElementById("status-line"),
        authGate: document.getElementById("auth-gate"),
        refreshBtn: document.getElementById("refresh-btn"),
        logsBtn: document.getElementById("logs-btn"),
        logoutBtn: document.getElementById("logout-btn"),
        themeBtn: document.getElementById("theme-btn"),
        summaryTotal: document.getElementById("summary-total"),
        summaryUp: document.getElementById("summary-up"),
        summaryDown: document.getElementById("summary-down"),
        summaryUnknown: document.getElementById("summary-unknown"),
        sessionExpiry: document.getElementById("session-expiry"),
        snapshotTime: document.getElementById("snapshot-time"),
        timelineChart: echarts.init(document.getElementById("timeline-chart")),
        distributionChart: echarts.init(document.getElementById("distribution-chart"))
      };

      const state = {
        selectedTrack: "",
        tracks: [],
        refreshTimer: null,
        logTimer: null,
        theme: "dark",
        rows: []
      };

      const THEME_KEY = "trackway_theme_v2";

      function pad2(value) {
        return String(value).padStart(2, "0");
      }

      function formatDateTime(value) {
        const date = new Date(value);
        if (Number.isNaN(date.valueOf())) return String(value);
        return `${pad2(date.getDate())}.${pad2(date.getMonth() + 1)}.${date.getFullYear()} ${pad2(date.getHours())}:${pad2(date.getMinutes())}:${pad2(date.getSeconds())}`;
      }

      function statusClass(status) {
        if (status === "UP") return "status-pill status-up";
        if (status === "DOWN") return "status-pill status-down";
        return "status-pill status-unknown";
      }

      function setStatus(text) {
        ui.statusLine.textContent = text;
      }

      function escapeHtml(value) {
        return String(value)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function normalizeRow(row) {
        return {
          timestamp: row.timestamp || row.Timestamp || "",
          status: row.status || row.Status || "",
          endpoint: row.endpoint || row.Endpoint || "",
          reason: row.reason || row.Reason || ""
        };
      }

      async function fetchJSON(url, options = {}) {
        const response = await fetch(url, {
          credentials: "include",
          headers: {
            Accept: "application/json",
            ...options.headers
          },
          ...options
        });
        let data = null;
        try {
          data = await response.json();
        } catch (_) {
          data = null;
        }
        if (!response.ok) {
          const message = data?.error || `HTTP ${response.status}`;
          const error = new Error(message);
          error.status = response.status;
          throw error;
        }
        return data;
      }

      function applyTheme(theme) {
        state.theme = theme === "light" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", state.theme);
        localStorage.setItem(THEME_KEY, state.theme);
        ui.themeBtn.textContent = state.theme === "dark" ? "Theme: Dark" : "Theme: Light";
      }

      function resolveInitialTheme() {
        const stored = localStorage.getItem(THEME_KEY);
        if (stored === "dark" || stored === "light") return stored;
        return "dark";
      }

      async function refreshSession() {
        const payload = await fetchJSON("/api/auth/session");
        ui.sessionExpiry.textContent = formatDateTime(payload.expires_at);
        return payload;
      }

      async function tryMiniAppAutoAuth() {
        const tg = window.Telegram?.WebApp;
        if (!tg || !tg.initData) return false;
        tg.ready?.();
        tg.expand?.();
        await fetchJSON("/api/auth/telegram-miniapp", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            init_data: tg.initData
          })
        });
        return true;
      }

      async function ensureAuthorized() {
        try {
          await refreshSession();
          ui.authGate.classList.add("hidden");
          return true;
        } catch (_) {
          try {
            const miniAppOk = await tryMiniAppAutoAuth();
            if (miniAppOk) {
              await refreshSession();
              ui.authGate.classList.add("hidden");
              return true;
            }
          } catch (_) {
            // no-op
          }
          ui.authGate.classList.remove("hidden");
          return false;
        }
      }

      function renderDistributionChart(snapshot) {
        const data = [
          { value: snapshot.up, name: "UP", itemStyle: { color: "#5cd89a" } },
          { value: snapshot.down, name: "DOWN", itemStyle: { color: "#ff6f8f" } },
          { value: snapshot.unknown, name: "UNKNOWN", itemStyle: { color: "#ffc36d" } }
        ];
        ui.distributionChart.setOption({
          backgroundColor: "transparent",
          tooltip: {
            trigger: "item"
          },
          legend: {
            bottom: 0,
            textStyle: {
              color: getComputedStyle(document.documentElement).getPropertyValue("--muted").trim()
            }
          },
          series: [
            {
              type: "pie",
              radius: ["42%", "70%"],
              center: ["50%", "46%"],
              label: { color: getComputedStyle(document.documentElement).getPropertyValue("--ink").trim() },
              data
            }
          ]
        });
      }

      function renderTimelineChart(rows) {
        const seriesData = rows.map((raw) => {
          const row = normalizeRow(raw);
          const value = row.status === "DOWN" ? 0 : row.status === "UP" ? 1 : null;
          return [row.timestamp, value];
        }).filter((item) => item[1] !== null);

        ui.timelineChart.setOption({
          backgroundColor: "transparent",
          tooltip: {
            trigger: "axis",
            axisPointer: { type: "line" },
            formatter: (params) => {
              if (!params || !params.length) return "";
              const first = params[0];
              const ts = formatDateTime(first.axisValue);
              const stateLabel = Number(first.data[1]) === 1 ? "UP" : "DOWN";
              return `${ts}<br/><b>${stateLabel}</b>`;
            }
          },
          grid: {
            left: 46,
            right: 18,
            top: 18,
            bottom: 56
          },
          xAxis: {
            type: "time",
            axisLabel: {
              color: getComputedStyle(document.documentElement).getPropertyValue("--muted").trim(),
              formatter: (value) => {
                const date = new Date(value);
                return `${pad2(date.getHours())}:${pad2(date.getMinutes())}`;
              }
            },
            axisLine: { lineStyle: { color: getComputedStyle(document.documentElement).getPropertyValue("--line").trim() } },
            splitLine: { show: false }
          },
          yAxis: {
            type: "value",
            min: 0,
            max: 1,
            interval: 1,
            axisLabel: {
              color: getComputedStyle(document.documentElement).getPropertyValue("--muted").trim(),
              formatter: (value) => (value === 1 ? "UP" : "DOWN")
            },
            axisLine: { show: false },
            splitLine: { lineStyle: { color: getComputedStyle(document.documentElement).getPropertyValue("--line").trim() } }
          },
          dataZoom: [
            {
              type: "inside",
              xAxisIndex: 0
            },
            {
              type: "slider",
              xAxisIndex: 0,
              height: 18,
              bottom: 12,
              borderColor: getComputedStyle(document.documentElement).getPropertyValue("--line").trim(),
              backgroundColor: "transparent",
              fillerColor: "rgba(101,184,255,0.18)"
            }
          ],
          series: [
            {
              name: "State",
              type: "line",
              step: "end",
              smooth: false,
              showSymbol: false,
              lineStyle: { width: 2, color: "#65b8ff" },
              areaStyle: { color: "rgba(101,184,255,0.18)" },
              data: seriesData
            }
          ]
        });
      }

      function renderTargetsTable(payload) {
        ui.statusTableBody.innerHTML = "";
        for (const target of payload.targets) {
          const row = document.createElement("tr");
          if (target.name === state.selectedTrack) row.classList.add("active");
          row.innerHTML = `
            <td>${escapeHtml(target.name)}</td>
            <td><code>${escapeHtml(target.address)}:${target.port}</code></td>
            <td><span class="${statusClass(target.status)}">${target.status}</span></td>
            <td><code>${escapeHtml(formatDateTime(target.last_changed))}</code></td>
            <td><code>${escapeHtml(formatDateTime(target.last_checked))}</code></td>
          `;
          row.addEventListener("click", () => {
            state.selectedTrack = target.name;
            syncTrackSelect();
            fillTargetForm(target);
            renderTargetsTable(payload);
            void loadLogs();
          });
          ui.statusTableBody.appendChild(row);
        }
      }

      function fillTargetForm(target) {
        if (!target) return;
        ui.targetNameInput.value = target.name || "";
        ui.targetAddressInput.value = target.address || "";
        ui.targetPortInput.value = String(target.port || 443);
      }

      function syncTrackSelect() {
        if (!state.tracks.length) {
          ui.trackSelect.innerHTML = "";
          return;
        }
        if (!state.selectedTrack || !state.tracks.includes(state.selectedTrack)) {
          state.selectedTrack = state.tracks[0];
        }
        ui.trackSelect.innerHTML = state.tracks
          .map((name) => `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`)
          .join("");
        ui.trackSelect.value = state.selectedTrack;
      }

      async function loadStatus() {
        const payload = await fetchJSON("/api/status");
        ui.summaryTotal.textContent = String(payload.total);
        ui.summaryUp.textContent = String(payload.up);
        ui.summaryDown.textContent = String(payload.down);
        ui.summaryUnknown.textContent = String(payload.unknown);
        ui.snapshotTime.textContent = formatDateTime(payload.generated_at);
        state.tracks = payload.targets.map((target) => target.name);
        syncTrackSelect();
        if (state.selectedTrack) {
          const selected = payload.targets.find((target) => target.name === state.selectedTrack);
          if (selected) {
            fillTargetForm(selected);
          }
        }
        renderTargetsTable(payload);
        renderDistributionChart(payload);
        setStatus(`Status updated ${formatDateTime(new Date().toISOString())}`);
      }

      async function upsertTarget() {
        const name = ui.targetNameInput.value.trim();
        const address = ui.targetAddressInput.value.trim();
        const port = Number(ui.targetPortInput.value);
        if (!name || !address || !Number.isFinite(port) || port < 1 || port > 65535) {
          throw new Error("Target fields are invalid");
        }
        await fetchJSON("/api/targets", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ name, address, port: Math.trunc(port) })
        });
      }

      async function deleteTarget() {
        const name = ui.targetNameInput.value.trim();
        if (!name) {
          throw new Error("Target name is required for delete");
        }
        await fetchJSON(`/api/targets?name=${encodeURIComponent(name)}`, {
          method: "DELETE"
        });
        if (state.selectedTrack === name) {
          state.selectedTrack = "";
        }
      }

      function buildLogText(rows) {
        if (!rows.length) return "(no rows)";
        return rows
          .map((raw) => {
            const row = normalizeRow(raw);
            return `${formatDateTime(row.timestamp)}  ${row.status}  ${row.endpoint}  ${row.reason}`;
          })
          .join("\n");
      }

      async function loadLogs() {
        if (!state.selectedTrack) {
          ui.logsMeta.textContent = "No track selected.";
          ui.logsOutput.textContent = "(no track)";
          renderTimelineChart([]);
          return;
        }
        const hours = Number(ui.rangeSelect.value) || 24;
        const limit = Number(ui.limitInput.value) || 10000;
        const tzOffset = -new Date().getTimezoneOffset();
        const query = new URLSearchParams({
          track: state.selectedTrack,
          hours: String(hours),
          limit: String(limit),
          tz_offset_minutes: String(tzOffset)
        });
        const payload = await fetchJSON(`/api/logs?${query.toString()}`);
        const rows = Array.isArray(payload.rows) ? payload.rows : [];
        state.rows = rows;
        ui.logsMeta.textContent = `Track: ${payload.track} | Range: ${hours}h | Rows: ${rows.length}`;
        ui.logsOutput.textContent = buildLogText(rows);
        renderTimelineChart(rows);
      }

      function clearTimers() {
        if (state.refreshTimer) clearInterval(state.refreshTimer);
        if (state.logTimer) clearInterval(state.logTimer);
        state.refreshTimer = null;
        state.logTimer = null;
      }

      async function logout() {
        try {
          await fetchJSON("/auth/logout", { method: "POST" });
        } catch (_) {
          // noop
        }
        clearTimers();
        ui.authGate.classList.remove("hidden");
        setStatus("Logged out");
      }

      async function bootstrap() {
        applyTheme(resolveInitialTheme());
        const ok = await ensureAuthorized();
        if (!ok) {
          setStatus("Authorization required");
          return;
        }
        await loadStatus();
        await loadLogs();

        clearTimers();
        state.refreshTimer = setInterval(() => {
          void loadStatus().catch((error) => setStatus(`Status error: ${error.message}`));
        }, 5000);
        state.logTimer = setInterval(() => {
          void loadLogs().catch((error) => setStatus(`Log error: ${error.message}`));
        }, 10000);
      }

      ui.refreshBtn.addEventListener("click", () => {
        void loadStatus().then(() => loadLogs()).catch((error) => setStatus(`Refresh error: ${error.message}`));
      });

      ui.logsBtn.addEventListener("click", () => {
        state.selectedTrack = ui.trackSelect.value;
        void loadLogs().catch((error) => setStatus(`Load logs error: ${error.message}`));
      });

      ui.rangeSelect.addEventListener("change", () => {
        void loadLogs().catch((error) => setStatus(`Range update error: ${error.message}`));
      });

      ui.trackSelect.addEventListener("change", () => {
        state.selectedTrack = ui.trackSelect.value;
        void loadLogs().catch((error) => setStatus(`Track update error: ${error.message}`));
      });

      ui.logoutBtn.addEventListener("click", () => {
        void logout();
      });

      ui.themeBtn.addEventListener("click", () => {
        applyTheme(state.theme === "dark" ? "light" : "dark");
        renderDistributionChart({
          total: Number(ui.summaryTotal.textContent),
          up: Number(ui.summaryUp.textContent),
          down: Number(ui.summaryDown.textContent),
          unknown: Number(ui.summaryUnknown.textContent)
        });
        renderTimelineChart(state.rows);
      });

      window.addEventListener("resize", () => {
        ui.timelineChart.resize();
        ui.distributionChart.resize();
      });

      ui.targetSaveBtn.addEventListener("click", () => {
        void upsertTarget()
          .then(() => loadStatus())
          .then(() => loadLogs())
          .then(() => setStatus("Target saved"))
          .catch((error) => setStatus(`Target save error: ${error.message}`));
      });

      ui.targetDeleteBtn.addEventListener("click", () => {
        void deleteTarget()
          .then(() => loadStatus())
          .then(() => loadLogs())
          .then(() => setStatus("Target deleted"))
          .catch((error) => setStatus(`Target delete error: ${error.message}`));
      });

      void bootstrap();
    </script>
  </body>
</html>
