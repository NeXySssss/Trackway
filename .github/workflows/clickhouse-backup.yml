name: ClickHouse Backup

on:
  schedule:
    - cron: "20 2 * * *"
  workflow_dispatch:

jobs:
  backup:
    name: Backup ClickHouse over SSH
    runs-on:
      - self-hosted
      - trackway
    env:
      DEPLOY_DIR: /opt/trackway
      BACKUP_DIR: /opt/trackway/backups
      COMPOSE_PROJECT_NAME: trackway
      BACKUP_KEEP: "30"
      DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
      DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
      DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
      DEPLOY_SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
      DEPLOY_SSH_KNOWN_HOSTS: ${{ secrets.DEPLOY_SSH_KNOWN_HOSTS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          set -euo pipefail
          if [ -z "${DEPLOY_SSH_HOST}" ]; then
            echo "Secret DEPLOY_SSH_HOST is required." >&2
            exit 1
          fi
          if [ -z "${DEPLOY_SSH_USER}" ]; then
            echo "Secret DEPLOY_SSH_USER is required." >&2
            exit 1
          fi
          if [ -z "${DEPLOY_SSH_PRIVATE_KEY}" ]; then
            echo "Secret DEPLOY_SSH_PRIVATE_KEY is required." >&2
            exit 1
          fi

      - name: Setup SSH key
        run: |
          set -euo pipefail
          mkdir -p "${HOME}/.ssh"
          chmod 700 "${HOME}/.ssh"
          printf '%s\n' "${DEPLOY_SSH_PRIVATE_KEY}" > "${HOME}/.ssh/id_trackway_deploy"
          chmod 600 "${HOME}/.ssh/id_trackway_deploy"

      - name: Setup known_hosts
        run: |
          set -euo pipefail
          port="${DEPLOY_SSH_PORT:-22}"
          if [ -n "${DEPLOY_SSH_KNOWN_HOSTS}" ]; then
            printf '%s\n' "${DEPLOY_SSH_KNOWN_HOSTS}" >> "${HOME}/.ssh/known_hosts"
          else
            ssh-keyscan -H -p "${port}" "${DEPLOY_SSH_HOST}" >> "${HOME}/.ssh/known_hosts"
          fi
          chmod 644 "${HOME}/.ssh/known_hosts"

      - name: Ensure remote deployment directories
        run: |
          set -euo pipefail
          port="${DEPLOY_SSH_PORT:-22}"
          ssh -i "${HOME}/.ssh/id_trackway_deploy" -p "${port}" \
            -o BatchMode=yes -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes \
            "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" \
            "mkdir -p '${DEPLOY_DIR}' '${BACKUP_DIR}'"

      - name: Sync repository to server
        run: |
          set -euo pipefail
          port="${DEPLOY_SSH_PORT:-22}"
          rsync -a --delete \
            --exclude '.git' \
            --exclude 'config.yaml' \
            --exclude 'backups/' \
            -e "ssh -i ${HOME}/.ssh/id_trackway_deploy -p ${port} -o BatchMode=yes -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes" \
            "${GITHUB_WORKSPACE}/" "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}:${DEPLOY_DIR}/"

      - name: Run remote backup script
        run: |
          set -euo pipefail
          port="${DEPLOY_SSH_PORT:-22}"
          ssh -i "${HOME}/.ssh/id_trackway_deploy" -p "${port}" \
            -o BatchMode=yes -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes \
            "${DEPLOY_SSH_USER}@${DEPLOY_SSH_HOST}" \
            "DEPLOY_DIR='${DEPLOY_DIR}' BACKUP_DIR='${BACKUP_DIR}' COMPOSE_PROJECT_NAME='${COMPOSE_PROJECT_NAME}' BACKUP_KEEP='${BACKUP_KEEP}' bash '${DEPLOY_DIR}/scripts/backup-clickhouse.sh' '${DEPLOY_DIR}' '${BACKUP_DIR}'"
