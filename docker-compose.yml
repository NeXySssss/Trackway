name: trackway

services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: trackway-clickhouse
    restart: unless-stopped
    environment:
      CLICKHOUSE_DB: trackway
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "1"
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query='SELECT 1'"]
      interval: 10s
      timeout: 3s
      retries: 10

  trackway:
    build: .
    image: "${TRACKWAY_IMAGE:-trackway:latest}"
    container_name: trackway
    restart: unless-stopped
    depends_on:
      clickhouse:
        condition: service_healthy
    read_only: true
    tmpfs:
      - /tmp
    environment:
      CONFIG_PATH: /app/config.yaml
    ports:
      - "8083:8080"
    volumes:
      - "${TRACKWAY_CONFIG_PATH:-./config.yaml}:/app/config.yaml:ro"

volumes:
  clickhouse-data:
    name: trackway-clickhouse-data
